<!DOCTYPE html SYSTEM "about:legacy-compat">
<html lang="en-US" data-preset="contrast" data-primary-color="#C14424" data-link-color="#C14424"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="UTF-8"><meta name="robots" content="noindex"><meta name="built-on" content="2025-10-01T18:55:34.9616419"><title>CORS | Backend Typescript</title><script type="application/json" id="virtual-toc-data">[{"id":"-ev0tpa_2","level":0,"title":"Что такое CORS и зачем он нужен","anchor":"#-ev0tpa_2"},{"id":"-ev0tpa_3","level":0,"title":"Типы запросов и preflight (предварительный) запрос","anchor":"#-ev0tpa_3"},{"id":"-ev0tpa_4","level":0,"title":"Ключевые CORS-заголовки и их смысл","anchor":"#-ev0tpa_4"},{"id":"-ev0tpa_5","level":0,"title":"Быстрый старт: пакет cors","anchor":"#-ev0tpa_5"},{"id":"-ev0tpa_6","level":0,"title":"Whitelist и динамический origin","anchor":"#-ev0tpa_6"},{"id":"-ev0tpa_7","level":0,"title":"Credentials (куки, заголовки авторизации) безопасно","anchor":"#-ev0tpa_7"},{"id":"-ev0tpa_8","level":0,"title":"Ручная настройка без пакета cors (понимание механики)","anchor":"#-ev0tpa_8"},{"id":"-ev0tpa_9","level":0,"title":"Оптимизация preflight (производительность)","anchor":"#-ev0tpa_9"},{"id":"-ev0tpa_10","level":0,"title":"Безопасность: частые ошибки и как их избежать","anchor":"#-ev0tpa_10"},{"id":"-ev0tpa_11","level":0,"title":"Отладка и диагностика","anchor":"#-ev0tpa_11"},{"id":"-ev0tpa_12","level":0,"title":"Dev proxy как альтернатива при локальной разработке","anchor":"#-ev0tpa_12"},{"id":"-ev0tpa_13","level":0,"title":"Краткий чек-лист настроек","anchor":"#-ev0tpa_13"}]</script><script type="application/json" id="topic-shortcuts"></script><link href="https://resources.jetbrains.com/writerside/apidoc/6.22.0-b776/app.css" rel="stylesheet"><link rel="icon" type="image/png" sizes="16x16" href="images/logo.png"><meta name="image" content=""><!-- Open Graph --><meta property="og:title" content="CORS | Backend Typescript"><meta property="og:description" content=""><meta property="og:image" content=""><meta property="og:site_name" content="Backend Typescript Help"><meta property="og:type" content="website"><meta property="og:locale" content="en_US"><meta property="og:url" content="writerside-documentation//1.0.0/cors.html"><!-- End Open Graph --><!-- Twitter Card --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content=""><meta name="twitter:title" content="CORS | Backend Typescript"><meta name="twitter:description" content=""><meta name="twitter:creator" content=""><meta name="twitter:image:src" content=""><!-- End Twitter Card --><!-- Schema.org WebPage --><script type="application/ld+json">{
    "@context": "http://schema.org",
    "@type": "WebPage",
    "@id": "writerside-documentation//1.0.0/cors.html#webpage",
    "url": "writerside-documentation//1.0.0/cors.html",
    "name": "CORS | Backend Typescript",
    "description": "",
    "image": "",
    "inLanguage":"en-US"
}</script><!-- End Schema.org --><!-- Schema.org WebSite --><script type="application/ld+json">{
    "@type": "WebSite",
    "@id": "writerside-documentation/#website",
    "url": "writerside-documentation/",
    "name": "Backend Typescript Help"
}</script><!-- End Schema.org --></head><body data-id="CORS" data-main-title="CORS" data-article-props="{&quot;seeAlsoStyle&quot;:&quot;links&quot;}" data-template="article" data-breadcrumbs="_ExpressJS.topic|ExpressJS"><div class="wrapper"><main class="panel _main"><header class="panel__header"><div class="container"><h3>Backend Typescript 1.0.0 Help</h3><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="CORS" id="CORS.topic">CORS</h1><section class="chapter"><h2 id="-ev0tpa_2" data-toc="-ev0tpa_2">Что такое CORS и зачем он нужен</h2><p id="-ev0tpa_14"><span class="tooltip" id="-ev0tpa_17" title="Механизм контроля кросс-доменных запросов между браузером и сервером">CORS</span> (Cross-Origin Resource Sharing) &mdash; это механизм безопасности браузера, который контролирует, может ли страница с одного источника (схема+домен+порт) обращаться к ресурсам другого источника. По умолчанию браузер ограничивает доступ из скриптов к ответам с другого источника. CORS позволяет серверу явно указать, кому и что можно запрашивать, с помощью специальных <span class="tooltip" id="-ev0tpa_18" title="Пара ключ:значение, влияющая на обработку запроса/ответа">заголовков</span>.</p><ul class="list _bullet" id="-ev0tpa_15"><li class="list__item" id="-ev0tpa_19"><p><span id="-ev0tpa_22"><b>Origin</b></span> &mdash; комбинация схемы (http/https), домена и порта. Разные порты уже разные источники.</p></li><li class="list__item" id="-ev0tpa_20"><p><span id="-ev0tpa_23"><b>Браузер</b></span> автоматически применяет правила CORS; для запросов с бекенда (сервер-&gt;сервер) CORS не требуется.</p></li><li class="list__item" id="-ev0tpa_21"><p><span id="-ev0tpa_24"><b>Сервер</b></span> решает, какие источники допустить, какими методами и с какими заголовками.</p></li></ul><aside class="prompt" data-type="warning" data-title="" id="-ev0tpa_16"><p>Если не настроить CORS, браузер заблокирует доступ фронтенду к ответу. Это выглядит как ошибка CORS в консоли, хотя сам запрос может успешно дойти до сервера.</p></aside></section><section class="chapter"><h2 id="-ev0tpa_3" data-toc="-ev0tpa_3">Типы запросов и preflight (предварительный) запрос</h2><p id="-ev0tpa_25">Браузер различает <span id="-ev0tpa_28"><b>простые</b></span> запросы и запросы, требующие предварительной проверки (preflight). Preflight посылается методом <code class="code" id="-ev0tpa_29">OPTIONS</code> и спрашивает у сервера разрешение на основной запрос.</p><ul class="list _bullet" id="-ev0tpa_26"><li class="list__item" id="-ev0tpa_30"><p><span id="-ev0tpa_32"><b>Простые запросы</b></span>: методы GET/HEAD/POST, заголовки только из безопасного набора (например, <code class="code" id="-ev0tpa_33">Accept</code>, <code class="code" id="-ev0tpa_34">Content-Type: application/x-www-form-urlencoded | text/plain | multipart/form-data</code>), без нестандартных заголовков.</p></li><li class="list__item" id="-ev0tpa_31"><p><span id="-ev0tpa_35"><b>Не простые</b></span>: любые другие методы (PUT, PATCH, DELETE), кастомные заголовки (например, <code class="code" id="-ev0tpa_36">X-Request-Id</code>), <code class="code" id="-ev0tpa_37">Content-Type</code> c application/json &mdash; всё это требует preflight.</p></li></ul><aside class="prompt" data-type="note" data-title="" id="-ev0tpa_27"><p>При preflight браузер посылает <code class="code" id="-ev0tpa_38">OPTIONS</code> с заголовками <code class="code" id="-ev0tpa_39">Origin</code>, <code class="code" id="-ev0tpa_40">Access-Control-Request-Method</code> и <code class="code" id="-ev0tpa_41">Access-Control-Request-Headers</code>. Сервер должен ответить разрешающими заголовками, иначе основной запрос не выполнится.</p></aside></section><section class="chapter"><h2 id="-ev0tpa_4" data-toc="-ev0tpa_4">Ключевые CORS-заголовки и их смысл</h2><ul class="list _bullet" id="-ev0tpa_42"><li class="list__item" id="-ev0tpa_44"><p><code class="code" id="-ev0tpa_51">Access-Control-Allow-Origin</code> &mdash; кому разрешено. Значение: конкретный origin (например, <code class="code" id="-ev0tpa_52">https://app.example.com</code>) или <code class="code" id="-ev0tpa_53">*</code> (всем).</p></li><li class="list__item" id="-ev0tpa_45"><p><code class="code" id="-ev0tpa_54">Access-Control-Allow-Methods</code> &mdash; какие методы разрешены (GET, POST, PUT, DELETE, ...).</p></li><li class="list__item" id="-ev0tpa_46"><p><code class="code" id="-ev0tpa_55">Access-Control-Allow-Headers</code> &mdash; какие запросные заголовки разрешены (например, <code class="code" id="-ev0tpa_56">Content-Type, Authorization</code>).</p></li><li class="list__item" id="-ev0tpa_47"><p><code class="code" id="-ev0tpa_57">Access-Control-Allow-Credentials</code> &mdash; можно ли отправлять куки/HTTP-авторизацию (<code class="code" id="-ev0tpa_58">true</code>/<code class="code" id="-ev0tpa_59">false</code>).</p></li><li class="list__item" id="-ev0tpa_48"><p><code class="code" id="-ev0tpa_60">Access-Control-Expose-Headers</code> &mdash; какие заголовки ответа будут доступны JS (по умолчанию доступ к большинству заголовков закрыт).</p></li><li class="list__item" id="-ev0tpa_49"><p><code class="code" id="-ev0tpa_61">Access-Control-Max-Age</code> &mdash; сколько секунд кешировать результат preflight, чтобы реже делать <code class="code" id="-ev0tpa_62">OPTIONS</code>.</p></li><li class="list__item" id="-ev0tpa_50"><p><code class="code" id="-ev0tpa_63">Vary: Origin</code> &mdash; сообщает кешам, что ответ зависит от заголовка <code class="code" id="-ev0tpa_64">Origin</code>.</p></li></ul><aside class="prompt" data-type="warning" data-title="" id="-ev0tpa_43"><p><code class="code" id="-ev0tpa_65">Access-Control-Allow-Origin: *</code> запрещён вместе с <code class="code" id="-ev0tpa_66">Allow-Credentials: true</code> &mdash; браузер отклонит такой ответ. Для куки и авторизации всегда возвращайте конкретный origin.</p></aside></section><section class="chapter"><h2 id="-ev0tpa_5" data-toc="-ev0tpa_5">Быстрый старт: пакет cors</h2><p id="-ev0tpa_67">Проще всего управлять CORS через официальный пакет <code class="code" id="-ev0tpa_70">cors</code> для Express.</p><div class="code-block" data-lang="ts">
        // src/app.ts (фрагмент)
        import express from &quot;express&quot;;
        import cors from &quot;cors&quot;;

        const app = express();

        app.use(cors({
            origin: &quot;https://app.example.com&quot;, // конкретный фронтенд
            methods: [&quot;GET&quot;, &quot;POST&quot;, &quot;PUT&quot;, &quot;PATCH&quot;, &quot;DELETE&quot;],
            allowedHeaders: [&quot;Content-Type&quot;, &quot;Authorization&quot;, &quot;X-Request-Id&quot;],
            exposedHeaders: [&quot;X-Total-Count&quot;, &quot;X-Request-Id&quot;],
            credentials: true, // разрешить куки/авторизацию
            maxAge: 600 // кэш preflight на 10 минут
        }));

        app.get(&quot;/health&quot;, (_req, res) =&gt; res.send(&quot;ok&quot;));
</div><aside class="prompt" data-type="tip" data-title="" id="-ev0tpa_69"><p>Если у вас несколько фронтендов, используйте функцию для <code class="code" id="-ev0tpa_71">origin</code> и whitelist.</p></aside></section><section class="chapter"><h2 id="-ev0tpa_6" data-toc="-ev0tpa_6">Whitelist и динамический origin</h2><div class="code-block" data-lang="ts">
        // src/middlewares/cors.ts
        import cors from &quot;cors&quot;;

        const whitelist = new Set([
            &quot;https://app.example.com&quot;,
            &quot;https://admin.example.com&quot;,
            &quot;http://localhost:5173&quot;
        ]);

        export const corsMiddleware = cors({
            origin: (origin, callback) =&gt; {
                // origin может быть undefined для некоторых инструментов и curl
                if (!origin || whitelist.has(origin)) {
                    callback(null, true);
                } else {
                    callback(new Error(&quot;Not allowed by CORS&quot;));
                }
            },
            credentials: true,
            methods: [&quot;GET&quot;, &quot;POST&quot;, &quot;PUT&quot;, &quot;PATCH&quot;, &quot;DELETE&quot;, &quot;OPTIONS&quot;],
            allowedHeaders: [&quot;Content-Type&quot;, &quot;Authorization&quot;, &quot;X-Request-Id&quot;],
            exposedHeaders: [&quot;X-Total-Count&quot;, &quot;X-Request-Id&quot;],
            maxAge: 600
        });

        // src/app.ts
        import express from &quot;express&quot;;
        import {corsMiddleware} from &quot;./middlewares/cors&quot;;

        const app = express();
        app.use(corsMiddleware);
</div><aside class="prompt" data-type="note" data-title="" id="-ev0tpa_73"><p>При динамическом значении <code class="code" id="-ev0tpa_74">origin</code> пакет автоматически проставляет соответствующий <code class="code" id="-ev0tpa_75">Access-Control-Allow-Origin</code> и <code class="code" id="-ev0tpa_76">Vary: Origin</code>.</p></aside></section><section class="chapter"><h2 id="-ev0tpa_7" data-toc="-ev0tpa_7">Credentials (куки, заголовки авторизации) безопасно</h2><p id="-ev0tpa_77">Чтобы браузер отправлял и принимал куки/токены между источниками, нужны настройки и на клиенте, и на сервере.</p><ul class="list _bullet" id="-ev0tpa_78"><li class="list__item" id="-ev0tpa_81"><p>Сервер: <code class="code" id="-ev0tpa_85">credentials: true</code> и <code class="code" id="-ev0tpa_86">Access-Control-Allow-Origin</code> не может быть <code class="code" id="-ev0tpa_87">*</code>.</p></li><li class="list__item" id="-ev0tpa_82"><p>Клиент: для fetch/axios указывается <code class="code" id="-ev0tpa_88">credentials: &quot;include&quot;</code>.</p></li><li class="list__item" id="-ev0tpa_83"><p>Куки: настройте <code class="code" id="-ev0tpa_89">SameSite=None; Secure</code> (иначе межсайтовая передача будет заблокирована современными браузерами).</p></li><li class="list__item" id="-ev0tpa_84"><p>Только HTTPS для <code class="code" id="-ev0tpa_90">SameSite=None; Secure</code>.</p></li></ul><div class="code-block" data-lang="ts"> // пример установки cookie в Express res.cookie(&quot;session&quot;, token, { httpOnly: true, secure: true, // обязательно в продакшн с HTTPS sameSite: &quot;none&quot;, // разрешить межсайтовую отправку domain: &quot;.example.com&quot;, // опционально: общий домен path: &quot;/&quot; }); </div><aside class="prompt" data-type="warning" data-title="" id="-ev0tpa_80"><p>Неправильная комбинация <code class="code" id="-ev0tpa_91">SameSite</code> и <code class="code" id="-ev0tpa_92">Secure</code> приводит к &laquo;пропадающим&raquo; куки. Проверяйте в DevTools -&gt; Application -&gt; Cookies.</p></aside></section><section class="chapter"><h2 id="-ev0tpa_8" data-toc="-ev0tpa_8">Ручная настройка без пакета cors (понимание механики)</h2><p id="-ev0tpa_93">Иногда полезно явно увидеть ответы на preflight и основной запрос.</p><div class="code-block" data-lang="ts"> // src/app.ts (минимальный пример) import express from &quot;express&quot;;

        const app = express();

        const ALLOWED_ORIGIN = &quot;https://app.example.com&quot;;

        app.use((req, res, next) =&gt; {
            res.setHeader(&quot;Access-Control-Allow-Origin&quot;, ALLOWED_ORIGIN);
            res.setHeader(&quot;Vary&quot;, &quot;Origin&quot;);
            res.setHeader(&quot;Access-Control-Allow-Credentials&quot;, &quot;true&quot;);
            res.setHeader(&quot;Access-Control-Expose-Headers&quot;, &quot;X-Total-Count, X-Request-Id&quot;);
            if (req.method === &quot;OPTIONS&quot;) {
                res.setHeader(&quot;Access-Control-Allow-Methods&quot;, &quot;GET,POST,PUT,PATCH,DELETE,OPTIONS&quot;);
                res.setHeader(&quot;Access-Control-Allow-Headers&quot;, req.header(&quot;Access-Control-Request-Headers&quot;) || &quot;Content-Type, Authorization&quot;);
                res.setHeader(&quot;Access-Control-Max-Age&quot;, &quot;600&quot;);
                return res.status(204).send();
            }
            next();
        });

        app.get(&quot;/api/data&quot;, (_req, res) =&gt; {
            res.setHeader(&quot;X-Request-Id&quot;, &quot;abc-123&quot;);
            res.json({ok: true});
        });
</div><aside class="prompt" data-type="tip" data-title="" id="-ev0tpa_95"><p>Ручной режим полезен для тонкой отладки и когда нужна особая логика на preflight. Но в большинстве случаев пакет <code class="code" id="-ev0tpa_96">cors</code> надёжнее и проще.</p></aside></section><section class="chapter"><h2 id="-ev0tpa_9" data-toc="-ev0tpa_9">Оптимизация preflight (производительность)</h2><ul class="list _bullet" id="-ev0tpa_97"><li class="list__item" id="-ev0tpa_99"><p>Используйте <code class="code" id="-ev0tpa_102">Access-Control-Max-Age</code> для кеширования разрешения браузером (например, 600&ndash;3600 секунд).</p></li><li class="list__item" id="-ev0tpa_100"><p>Сведите к минимуму нестандартные заголовки и меняйте их только при необходимости &mdash; меньше причин для preflight.</p></li><li class="list__item" id="-ev0tpa_101"><p>Стабилизируйте набор методов и заголовков &mdash; частые изменения могут приводить к лишним <code class="code" id="-ev0tpa_103">OPTIONS</code>.</p></li></ul><aside class="prompt" data-type="note" data-title="" id="-ev0tpa_98"><p>Preflight &mdash; это сетевой RTT. На высоких латенсиях и мобильных сетях лишние <code class="code" id="-ev0tpa_104">OPTIONS</code> заметно замедляют UX.</p></aside></section><section class="chapter"><h2 id="-ev0tpa_10" data-toc="-ev0tpa_10">Безопасность: частые ошибки и как их избежать</h2><ul class="list _bullet" id="-ev0tpa_105"><li class="list__item" id="-ev0tpa_107"><p><span id="-ev0tpa_112"><b>Отражение Origin без валидации</b></span>: установка <code class="code" id="-ev0tpa_113">Access-Control-Allow-Origin</code> равным входящему <code class="code" id="-ev0tpa_114">Origin</code> без whitelist &mdash; риск утечки данных. Всегда проверяйте против списка.</p></li><li class="list__item" id="-ev0tpa_108"><p><span id="-ev0tpa_115"><b>Allow-Credentials с *</b></span>: браузер заблокирует такой ответ; используйте конкретный origin.</p></li><li class="list__item" id="-ev0tpa_109"><p><span id="-ev0tpa_116"><b>Слишком широкий Allow-Headers</b></span>: разрешайте только нужные заголовки, чтобы сузить поверхность атаки.</p></li><li class="list__item" id="-ev0tpa_110"><p><span id="-ev0tpa_117"><b>Отсутствует Vary: Origin</b></span>: кэши могут отдать ответ не тому источнику. Добавляйте <code class="code" id="-ev0tpa_118">Vary</code> при динамическом разрешении origin.</p></li><li class="list__item" id="-ev0tpa_111"><p><span id="-ev0tpa_119"><b>HTTP вместо HTTPS</b></span>: для <code class="code" id="-ev0tpa_120">SameSite=None</code> куки должны быть <code class="code" id="-ev0tpa_121">Secure</code>, то есть только HTTPS.</p></li></ul><aside class="prompt" data-type="warning" data-title="" id="-ev0tpa_106"><p>Неправильный CORS не делает ваш API &quot;публичным&quot; безопасно &mdash; он лишь открывает доступ скриптам из браузера. Для защиты содержимого используйте аутентификацию, авторизацию и контроль выдачи данных.</p></aside></section><section class="chapter"><h2 id="-ev0tpa_11" data-toc="-ev0tpa_11">Отладка и диагностика</h2><ul class="list _bullet" id="-ev0tpa_122"><li class="list__item" id="-ev0tpa_124"><p>Смотрите вкладку &quot;Network&quot; в DevTools: есть ли запрос <code class="code" id="-ev0tpa_128">OPTIONS</code>, какие заголовки пришли/ушли.</p></li><li class="list__item" id="-ev0tpa_125"><p>Проверьте консоль: браузер пишет причину блокировки CORS (какого заголовка не хватает).</p></li><li class="list__item" id="-ev0tpa_126"><p>Логируйте на сервере заголовки <code class="code" id="-ev0tpa_129">Origin</code>, <code class="code" id="-ev0tpa_130">Access-Control-Request-Method</code>, <code class="code" id="-ev0tpa_131">Access-Control-Request-Headers</code> для preflight.</p></li><li class="list__item" id="-ev0tpa_127"><p>Тестируйте curl-ом серверную реакцию (curl не применяет CORS, но помогает увидеть заголовки ответа).</p></li></ul><div class="code-block" data-lang="bash">
            curl -i -X OPTIONS &quot;https://api.example.com/resource&quot; \
            -H &quot;Origin: https://app.example.com&quot; \
            -H &quot;Access-Control-Request-Method: PUT&quot; \
            -H &quot;Access-Control-Request-Headers: Content-Type, Authorization&quot; </div></section><section class="chapter"><h2 id="-ev0tpa_12" data-toc="-ev0tpa_12">Dev proxy как альтернатива при локальной разработке</h2><p id="-ev0tpa_132">Чтобы реже трогать CORS в деве, используйте прокси в дев-сервере фронта (Vite/webpack). Тогда запросы уходят на тот же origin, а прокси перенаправляет их на API.</p><aside class="prompt" data-type="note" data-title="" id="-ev0tpa_133"><p>Прокси решает CORS только в dev. В продакшне всё равно нужно корректно настроить заголовки на сервере.</p></aside></section><section class="chapter"><h2 id="-ev0tpa_13" data-toc="-ev0tpa_13">Краткий чек-лист настроек</h2><ul class="list _bullet" id="-ev0tpa_134"><li class="list__item" id="-ev0tpa_135"><p>Определите, какие фронтенды (origin) должны иметь доступ &mdash; сделайте whitelist.</p></li><li class="list__item" id="-ev0tpa_136"><p>Разрешите только нужные методы и заголовки (<code class="code" id="-ev0tpa_140">Allow-Methods</code>, <code class="code" id="-ev0tpa_141">Allow-Headers</code>).</p></li><li class="list__item" id="-ev0tpa_137"><p>Если нужны куки/авторизация &mdash; <code class="code" id="-ev0tpa_142">credentials: true</code>, конкретный <code class="code" id="-ev0tpa_143">Allow-Origin</code>, куки с <code class="code" id="-ev0tpa_144">SameSite=None; Secure</code>.</p></li><li class="list__item" id="-ev0tpa_138"><p>Настройте <code class="code" id="-ev0tpa_145">Max-Age</code> для кеширования preflight.</p></li><li class="list__item" id="-ev0tpa_139"><p>Добавьте <code class="code" id="-ev0tpa_146">Vary: Origin</code> при динамическом разрешении.</p></li></ul></section><div class="last-modified">01 октября 2025</div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom"><a href="expressjs.html" class="navigation-links__prev">ExpressJS</a><a href="mvc.html" class="navigation-links__next">MVC</a></div></article><div id="disqus_thread"></div></div></section></main></div><script src="https://resources.jetbrains.com/writerside/apidoc/6.22.0-b776/app.js"></script></body></html>