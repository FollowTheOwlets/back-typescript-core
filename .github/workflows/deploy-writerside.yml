name: Build & Deploy WriterSide

on:
  push:
    branches: [ "master" ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

env:
  # Инстанс из writerside.cfg
  INSTANCE: "Writerside/back-typescript"

# Отменять старые прогоны для той же ветки
concurrency:
  group: pages-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Build docs via WriterSide
        uses: JetBrains/writerside-github-action@v4
        with:
          instance: ${{ env.INSTANCE }}

      - name: Upload artifact (whole artifacts dir)
        uses: actions/upload-artifact@v4
        with:
          name: writerside
          path: artifacts/
          retention-days: 7

  test:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: writerside
          path: artifacts

      - name: Check build report
        uses: JetBrains/writerside-checker-action@v1
        with:
          instance: ${{ env.INSTANCE }}

  deploy:
    needs: [build, test]
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deploy.outputs.page_url }}
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: writerside
          path: artifacts

      - name: Find site zip
        id: findzip
        shell: bash
        run: |
          set -e
          SITE_ZIP=$(ls artifacts/webHelp*2-all.zip | head -n1 || true)
          if [ -z "$SITE_ZIP" ]; then
            echo "❌ Site zip not found (pattern: artifacts/webHelp*2-all.zip)"; exit 1;
          fi
          echo "site_zip=$SITE_ZIP" >> "$GITHUB_OUTPUT"

      - name: Unzip website
        run: unzip -O UTF-8 -qq "${{ steps.findzip.outputs.site_zip }}" -d site

      # ---------- Pagefind: статический бесплатный поиск ----------
      - name: Build static search index (Pagefind)
        run: |
          if ! command -v npm >/dev/null 2>&1; then
            sudo apt-get update -y && sudo apt-get install -y nodejs npm
          fi
          # Кладём bundle в сам сайт, чтобы пути работали на Pages
          npx --yes pagefind --source site --bundle-dir pagefind

      - name: Verify Pagefind assets
        run: ls -lah site/pagefind

      # ---------- Тема: переопределяем цвета для светлой/тёмной тем ----------
      - name: Add theme overrides CSS (light/dark)
        shell: bash
        run: |
          cat > site/theme-overrides.css <<'CSS'
          :root.theme-light, :root.theme-dark {
            --wt-color-primary-dark-theme: #C14424;
            --wt-color-primary-dark-theme-80: rgba(193, 68, 36, 0.8);
            --wt-color-primary-dark-theme-20: rgba(193, 68, 36, 0.2);
            --rs-color-primary-dark-theme: #C14424;
            --rs-color-primary-dim-dark-theme: #9F3B22;
            --rs-color-primary-fog-dark-theme: #4B261E;
            --rs-color-primary-t-dim-dark-theme: rgba(193, 68, 36, 0.8);
            --rs-color-primary-t-fog-dark-theme: rgba(193, 68, 36, 0.3);
            --wt-color-primary-light-theme: #C14424;
            --wt-color-primary-light-theme-80: rgba(193, 68, 36, 0.8);
            --wt-color-primary-light-theme-20: rgba(193, 68, 36, 0.2);
            --rs-color-primary-light-theme: #C14424;
            --rs-color-primary-dim-light-theme: #CD6950;
            --rs-color-primary-fog-light-theme: #F3DAD3;
            --rs-color-primary-t-dim-light-theme: rgba(193, 68, 36, 0.8);
            --rs-color-primary-t-fog-light-theme: rgba(193, 68, 36, 0.2);
            --app-link-color: #C14424;
            --app-link-border-color: rgba(193, 68, 36, 0.2);
            --app-link-color-dark: #C14424;
            --app-link-border-color-dark: rgba(193, 68, 36, 0.2);
          }
          
          :root.theme-light {
            --bg: var(--wh-color-white);
            --fg: var(--wh-color-text-main);
            --primary: var(--wh-color-primary-light-theme);
            --header-bg: var(--app-header);
            --pagefind-ui-text: var(--wh-color-text-main);
          }
          
          :root.theme-dark {
            --bg: var(--app-header);
            --fg: var(--wh-color-text-main);
            --primary: var(--wh-color-primary-light-theme);
            --header-bg: var(--app-header);
            --on-primary: var(--wh-color-text-secondary);
            --pagefind-ui-text: var(--wh-color-text-main);
            --pagefind-ui-background: var(--app-header);
            --pagefind-ui-primary: var(--wh-color-white);
          }
          
          .pagefind-ui--reset ol {
              overflow: auto;
              max-height: 400px;
          }
          
          .list>li:before {
            content: "•";
          }
          CSS
      # ---------- Модалка/хоткей Ctrl+K + кнопка; корректные пути на Pages ----------
      - name: Add Pagefind modal script (absolute basePath) and inject into pages
        shell: bash
        run: |
          cat > site/pagefind-inline.js <<'JS'
          (function () {
            const STYLE_ID = 'pf-inline-style';
            const MODAL_ID = 'pf-modal';
            const BTN_ID = 'pf-trigger';
            // "/<repo>/" для проектных страниц или "/" для user/org домена
            const basePath = (function(){ const seg = location.pathname.split('/')[1]; return seg ? `/${seg}/` : '/'; })();

            if (!document.querySelector('link[href*="pagefind-ui.css"]')) {
              const l = document.createElement('link'); l.rel='stylesheet'; l.href = basePath + 'pagefind/pagefind-ui.css'; document.head.appendChild(l);
            }
            if (!document.querySelector('link[href*="theme-overrides.css"]')) {
              const l = document.createElement('link'); l.rel='stylesheet'; l.href = basePath + 'theme-overrides.css'; document.head.appendChild(l);
            }
          
            function ensureStyle() {
              if (document.getElementById(STYLE_ID)) return;
              const s = document.createElement('style'); s.id = STYLE_ID;
              s.textContent = `
                #${MODAL_ID}{position:fixed;inset:0;display:none;z-index:2147483647;background:var(--pf-modal-backdrop, rgba(0,0,0,.45))}
                #${MODAL_ID}.open{display:block}
                #${MODAL_ID} .pf-dialog{box-sizing:border-box;position:relative;margin:8vh auto;max-width:960px;width:92%;
                  background:var(--bg,#fff);color:var(--fg,#111);border-radius:12px;padding:16px 16px 8px;box-shadow:0 20px 60px rgba(0,0,0,.35)}
                #${BTN_ID}{opacity:.85;backdrop-filter:saturate(180%) blur(6px);
                  border-radius:8px;border:1px solid rgba(255,255,255,.25);padding:6px 10px;font:500 13px/1 system-ui,-apple-system,Segoe UI,Roboto,Arial;cursor:pointer;
                  background:var(--primary,#3b82f6);color:var(--on-primary,#fff);border-color:var(--primary,#3b82f6)}
                #${BTN_ID}:hover{opacity:1}
              `;
              document.head.appendChild(s);
            }

            function ensureModal() {
              if (document.getElementById(MODAL_ID)) return;
              const m = document.createElement('div'); m.id = MODAL_ID;
              m.innerHTML = `<div class="pf-dialog"><div id="pf-ui"></div></div>`;
              m.addEventListener('click', (e)=>{ if(e.target===m) close(); });
              document.body.appendChild(m);
            }

            function ensureButton() {
              if (document.getElementById(BTN_ID)) return;
              const b = document.createElement('button'); 
              b.id = BTN_ID; 
              b.type='button'; 
              b.title='Search';
              b.textContent = 'Поиск'; 
              b.addEventListener('click', open); 
              document.querySelector(".wh-header").appendChild(b)
            }

            function open(e){
              if (e) e.preventDefault();
              ensureModal();
              const modal = document.getElementById(MODAL_ID);
              modal.classList.add('open');
              if (!window.__pf_ui_inited) {
                window.__pf_ui_inited = true;
                new PagefindUI({ element: '#pf-ui', showSubResults: true, translations: { placeholder: 'Поиск…' } });
                setTimeout(() => { document.querySelector('#pf-ui input')?.focus(); }, 0);
              } else {
                document.querySelector('#pf-ui input')?.focus();
              }
            }

            function close(){ document.getElementById(MODAL_ID)?.classList.remove('open'); }
            function keyHandler(e){ if ((e.ctrlKey||e.metaKey) && /k/i.test(e.key)) { e.preventDefault(); open(e); } if (e.key==='Escape') close(); }

            function init(){
              ensureStyle(); ensureModal(); ensureButton();
              window.addEventListener('keydown', keyHandler, { passive: false });
            }

            function ensurePagefind(cb){
              if (window.PagefindUI) { cb(); return; }
              const s = document.createElement('script'); s.defer=true; s.src = basePath + 'pagefind/pagefind-ui.js';
              s.onload = cb; document.head.appendChild(s);
            }

            const interval = setInterval(() => {
              try {
                ensurePagefind(init);
                clearInterval(interval);
              } catch {}
            }, 1000);
          })();
          JS

          # Лоадер, подключающий pagefind-inline.js из корня сайта — корректно и на внутренних URL
          find site -type f -name "*.html" -print0 | xargs -0 -I{} sh -c \
            'grep -q "LOAD_PF_INLINE" "{}" || sed -i "s#</body>#<script>/*LOAD_PF_INLINE*/(function(){var seg=location.pathname.split(\x27/\x27)[1];var base=seg? \x27/\x27+seg+\x27/\x27 : \x27/\x27;var s=document.createElement(\x27script\x27);s.defer=true;s.src=base+\x27pagefind-inline.js\x27;document.body.appendChild(s);}());</script></body>#" "{}"'

      - name: Setup Pages
        uses: actions/configure-pages@v4
        with:
          enablement: true

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: site

      - name: Deploy to GitHub Pages
        id: deploy
        uses: actions/deploy-pages@v4
